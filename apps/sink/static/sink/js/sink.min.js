var sortWithFixedGroup=function(e,column){e.preventDefault();var dir="asc";var test=tabulatorTable.getSorters();tabulatorTable.getSorters().forEach(function(sort){if(column.getField()==sort.column.getField()){dir=sort.dir}})
tabulatorTable.setSort([{column:column,dir:(dir=="asc"?"desc":"asc")},{column:"header",dir:"asc"},])}
var tickToggle=function(e,cell){var value=cell.getValue();if(value!==null){cell.setValue(!value);changeState(StateEnum.SELECTION_CHANGED)}}
var loggedIn=!0,state,StateEnum={INITIAL:1,FILES_ADDED:2,FINAL:3,SELECTION_CHANGED:4,NONE_SELECTED:5,ALL_SELECTED:6,},maxFiles=100,maxLanguages=5,movieFiles=[],fileSelectClass=document.getElementsByClassName("select"),tabulatorTable=new Tabulator("#subtitle-table",{placeholder:"No titles added yet",pagination:"local",paginationSize:25,paginationSizeSelector:[10,25,50,100],layout:"fitColumns",layoutColumnsOnNewData:!0,columns:[{title:"#",field:"id",width:1,widthShrink:1,sorter:"string",visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Enabled",field:"enabled",visible:!1},{title:"Header",field:"header",visible:!1},{title:"link_gz",field:"link_gz",visible:!1},{title:"link_zip",field:"link_zip",visible:!1},{title:"language_id",field:"language_id",visible:!1},{title:"Added titles",field:"placeholder",formatter:"html",visible:!0,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Movie size (bytes)",field:"file_size",width:160,widthShrink:1,visible:!0,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Movie hash",field:"hash",width:160,widthShrink:1,visible:!0,headerSort:!1,headerClick:sortWithFixedGroup},{title:"<i id='select-header' class='select-cell fas fa-check-square' select-all='checked'></i>",width:40,widthShrink:1,headerSort:!1,field:"select",visible:!1,cellClick:tickToggle,formatter:"tickCross",formatterParams:{allowEmpty:!0,tickElement:"<i class='select-cell fas fa-check-square'></i>",crossElement:"<i class='select-cell far fa-square'></i>",}},{title:"Subtitle file",field:"sub_filename",minWidth:150,sorter:"string",visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"S",field:"season",width:44,widthShrink:1,sorter:"string",headerTooltip:"Season",widthShrink:1,visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"E",field:"episode",width:44,widthShrink:1,sorter:"string",headerTooltip:"Episode",widthShrink:1,visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Language",field:"language_name",width:140,minWidth:70,widthShrink:1,sorter:"string",visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Format",field:"format",width:83,widthShrink:1,sorter:"string",visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Encoding",field:"encoding",width:100,widthShrink:1,sorter:"string",visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Date added",field:"add_date",width:150,widthShrink:1,visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Score",field:"score",width:76,widthShrink:1,sorter:"number",visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Rating",field:"rating",width:80,widthShrink:1,sorter:"number",visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Uploader rank",field:"rank",sorter:"string",width:140,widthShrink:1,visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"#DL",field:"num_downloads",sorter:"number",width:65,widthShrink:1,headerTooltip:"Number of downloads by others",visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Download",field:"download",formatter:"html",width:110,minWidth:110,visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},],resizableColumns:!0,rowFormatter:function(row){var data=row.getData();if(data.enabled==!1){row.getElement().style.backgroundColor='#ffffe5';row.getElement().style.fontStyle='italic'}},groupBy:"header",groupToggleElement:"header",groupStartOpen:function(value,count,data,group){return data[0].id==1},groupClick:function(e,group){scrollPosX=window.scrollX;scrollPosY=window.scrollY},groupVisibilityChanged:function(group,visible){window.scrollTo(scrollPosX,scrollPosY)},pageLoaded:function(pageno){window.scrollTo(scrollPosX,scrollPosY)},},scrollPosX=0,scrollPosY=0);function redrawTable(){tabulatorTable.redraw()}
function addTableData(tableData,statusMessage){var tableId=tableData.id;tabulatorTable.updateOrAddData([tableData]).then(function(rows){}).catch(function(error){})}
var addMovieFilesToTable=function(){var file_array=[].slice.call(this.files)
var files=file_array.sort(function(a,b){return(a.name<=b.name?-1:1)});function loadFiles(startId){var id=startId;if(id+files.length>maxFiles+1){window.alert("Sorry, you can only add a maximum of 100 titles.\nOtherwise the U-Boat may sink and not surface no more...");return}
for(i=0;i<files.length;i++){var file=files[i];var titleAlreadyAdded=!1;for(var j=0;j<movieFiles.length;j++){if(movieFiles[j].movie_filename==file.name){titleAlreadyAdded=!0;break}}
if(!titleAlreadyAdded){calcFileHash(file,onHashCalculated(id));id++}}}
function onHashCalculated(id){function callback(file,hash){var fileData={'id':id,'header':file.name,'movie_filename':file.name,'placeholder':'<i>Fetch subtitles to display them in this table</i>','file_size':file.size.toString().replace(/\B(?=(?:\d{3})+(?!\d))/g,','),'hash':hash,};addFileData(fileData)}
return callback}
function addFileData(fileData){movieFiles.push(fileData);addTableData(fileData);changeState(StateEnum.FILES_ADDED)}
nextId=tabulatorTable.getDataCount()+1
loadFiles(nextId)};function fetchAndDisplaySubtitles(onFinish){var searchData={"movie_files":movieFiles};langSelectElement=$('#language-select');if(langSelectElement[0].selectedOptions.length==langSelectElement[0].length){searchData.languages=['all']}
else{searchData.languages=$('#language-select').val()}
$('input[type="radio"]:checked').each(function(){searchData.search_method=$(this).val()});var availableLanguages={};getAvailableLanguages(function(languages){this.availableLanguages=languages})
var onSuccess=function(subtitleData){$('#collapseOne').collapse();var rows=tabulatorTable.getRows();var numRows=tabulatorTable.getDataCount();for(var i=1;i<numRows+1;i++){tabulatorTable.getRow(i).delete()}
var unsortedResults=[];var id=1;for(var i=0;i<rows.length;i++){var row=rows[i];var rowData=row.getData();var movieName=rowData.movie_filename;var retrievedResult=subtitleData[movieName];for(j in retrievedResult){result=retrievedResult[j];result.id=id;result.header=movieName;if(result.sub_filename){result.select=!0;result.download="<a href='"+result.link_zip+"' target='_blank'>ZIP</a>&nbsp;&nbsp;<a href='"+result.link_gz+"' target='_blank'>GZ</a>&nbsp;&nbsp;<button class='btn-unzip' zip='"+result.link_zip+"' onclick='unzipAndLink(this)'>"+result.format.toUpperCase()+"</button>"}
else{result.select=null;result.sub_filename='Language not found for this title';result.language_name=this.availableLanguages[result.language_id][0];result.enabled=!1}
addTableData(result);id++}}
var columns=tabulatorTable.getColumns();for(i=6;i<columns.length;i++){columns[i].toggle()}
var groups=tabulatorTable.getGroups();for(i in groups){groups[i].show()}
tabulatorTable.setSort([{column:"header",dir:"asc"},{column:"language_name",dir:"asc"},]);redrawTable();onFinish()}
var onError=function(jQxhr){if(jQxhr.status==401){changeState(StateEnum.INITIAL);$("#edit-login-btn").click();guiLoginError(jQxhr.responseText)}else if(jQxhr.status==403){$("#seek_status").prop('hidden',!0);$("#page_error").prop('hidden',!1);changeState(StateEnum.FINAL)}}
searchSubtitles(searchData,onSuccess,onError)}
function unzipAndLink(button){var zipUrl=button.getAttribute("zip");var node=document.createElement("i");node.classList.add('fas');node.classList.add('fa-circle-notch');node.classList.add('fa-spin');button.innerHTML='';button.classList.add('buttonload');button.appendChild(node);model.getEntries(zipUrl,function(entries){entries.forEach(function(entry){if(button.parentNode){var row_id=button.parentNode.parentNode.querySelector('[tabulator-field="id"]').innerText;var row=tabulatorTable.getRow(row_id);var rowData=row.getData();var subtitleExtension=rowData.format;var ext=entry.filename.slice(-3);if(ext.toUpperCase()==subtitleExtension.toUpperCase()){var markup=rowData.download;var parser=new DOMParser();var elements=parser.parseFromString(markup,"text/html");var buttonElem=elements.getElementsByTagName("button")[0];buttonElem.remove();var aId=subtitleExtension+'_'+row_id;var newContent=elements.body.innerHTML+'<a href="#" id="'+aId+'">'+subtitleExtension.toUpperCase()+'</a>';tabulatorTable.updateData([{id:row_id,download:newContent}])
entry.filename='['+rowData.language_id.toUpperCase()+'] '+entry.filename;var a=document.getElementById(aId);download(entry,a).then(function(){newContent=elements.body.innerHTML+a.outerHTML;tabulatorTable.updateData([{id:row_id,download:newContent}])});event.preventDefault();row.reformat()}}})},function(status,message,url){button.classList.remove('buttonload');node.classList.remove('fas');node.classList.remove('fa-circle-notch');node.classList.remove('fa-spin');node.classList.add('fa');node.classList.add('fa-exclamation-circle');$("#manual-download").attr("href",url);$("#download_error").prop('hidden',!1)})}
function zipOfCompressedFiles(zip_choice,onSuccess){var processed_files={}
var files_to_download=[];var rows=tabulatorTable.getRows();for(i in rows){data=rows[i].getData();if(data.select){var file_name='['+data.language_id.toUpperCase()+'] '+data.sub_filename
var link=data['link_'+zip_choice]
if(processed_files.hasOwnProperty(file_name)){processed_files[file_name]++
file_name=file_name+' ('+processed_files[file_name]+')'}else{processed_files[file_name]=0}
files_to_download.push({'file_name':file_name+'.'+zip_choice,'link':link,})}}
downloadFiles(files_to_download).then(onSuccess)}
function downloadFiles(files){return new Promise(function(resolve,reject){blobs=[];files.forEach(function(file){downloadSubtitleAsBlob(file.link,function(blob){blob.name=file.file_name;blobs.push(blob)
if(files.length==blobs.length){resolve(blobs)}})})})}
function zipOfSubtitles(onSuccess,onError){var processed_files={}
var blobs_to_zip=[];var rows=tabulatorTable.getRows();for(i in rows){data=rows[i].getData();if(data.select){var file_name='['+data.language_id.toUpperCase()+'] '+data.sub_filename;var link=data.link_zip
if(processed_files.hasOwnProperty(file_name)){processed_files[file_name]++
var file_ext_index=file_name.lastIndexOf('.');var file_root=file_name.slice(0,file_ext_index);var ext=file_name.slice(file_ext_index);file_name=file_root+' ('+processed_files[file_name]+')'+ext}else{processed_files[file_name]=0}
blobs_to_zip.push({'file_name':file_name,'format':data.format,'link':link,})}}
var blobs=[];for(i in blobs_to_zip){var zipUrl=blobs_to_zip[i].link
function processFile(i){model.getEntries(zipUrl,function(entries){entries.forEach(function(entry){var file_ext=entry.filename.slice(-3);if(file_ext.toUpperCase()==blobs_to_zip[i].format.toUpperCase()){function addBlobs(blobs){return function(blob){blob.name=blobs_to_zip[i].file_name;blobs.push(blob);if(blobs.length===blobs_to_zip.length){onSuccess(blobs)}}}
downloadBlob(entry).then(addBlobs(blobs))}})},function(status,message,url){onError()})}
processFile(i)}}
function zipSelection(zip_choice){var downloadBtn=document.getElementById('download-selection');var node=document.createElement("i");node.classList.add('fas');node.classList.add('fa-circle-notch');node.classList.add('fa-spin');downloadBtn.innerHTML='';downloadBtn.classList.add('buttonload');downloadBtn.appendChild(node);var zipBlobs=function(blobs){zipModel.setCreationMethod("Blob");zipModel.addFiles(blobs,function(){},function(){},function(){},function(){zipModel.getBlobURL(function(blobUrl){var newLink=document.createElement('a');newLink.appendChild(document.createTextNode("Download selection"));newLink.style.visibility="hidden";newLink.setAttribute('href',blobUrl);newLink.setAttribute('download','uboat_subtitles.zip');document.body.appendChild(newLink);newLink.click();newLink.remove();downloadBtn.removeChild(node);downloadBtn.classList.remove('buttonload');downloadBtn.innerHTML='Download selection'})})}
if(zip_choice==='sub'){zipOfSubtitles(zipBlobs,function(status){downloadBtn.classList.remove('buttonload');downloadBtn.classList.remove('btn-primary');downloadBtn.classList.add('btn-warning');node.classList.remove('fas');node.classList.remove('fa-circle-notch');node.classList.remove('fa-spin');node.classList.add('fa');node.classList.add('fa-exclamation-circle');node.classList.add('black');$("#manual-download").removeAttr("href");$("#download_error").prop('hidden',!1)})}else{zipOfCompressedFiles(zip_choice,zipBlobs)}}
function changeState(state){switch(state){case StateEnum.INITIAL:tabulatorTable.redraw();break;case StateEnum.FILES_ADDED:$('#fetch-btn').removeClass('disabled');$('#fetch-btn').attr('aria-disabled',!1);break;case StateEnum.FINAL:$("#choose-titles-btn").prop('hidden',!0);$("#start-over-btn").prop('hidden',!1);$('#fetch-btn').addClass('disabled');$('#fetch-btn').attr('aria-disabled',!0);case StateEnum.SELECTION_CHANGED:var languageFound=!1;var noneSelected=!0;var rows=tabulatorTable.getRows();rows.forEach(function(row){var data=row.getData()
if(data.select!==null){languageFound=!0;if(data.select===!0){noneSelected=!1}}});if(languageFound&&!noneSelected){$('#download-selection').removeClass('disabled');$('#download-selection').attr('aria-disabled',!1);$("#zip_contents").prop('disabled',!1)}else{$('#download-selection').addClass('disabled');$('#download-selection').attr('aria-disabled',!0);$("#zip_contents").prop('disabled',!0);if($("#select-header").attr("select-all")==="checked"){$("#select-header").trigger("click")}}
break;case StateEnum.NONE_SELECTED:$('#download-selection').addClass('disabled');$('#download-selection').attr('aria-disabled',!0);$("#zip_contents").prop('disabled',!0);break;case StateEnum.ALL_SELECTED:$('#download-selection').removeClass('disabled');$('#download-selection').attr('aria-disabled',!1);$("#zip_contents").prop('disabled',!1);break;default:console.log("ERROR: Reached default in switch statement")}
state=state}
for(var i=0;i<fileSelectClass.length;i++){fileSelectClass[i].addEventListener('change',addMovieFilesToTable)}
function getHealthStatus(successStatus,maxRetries,onSuccess,onError){var urls=['server_health','https://api.opensubtitles.org/xml-rpc',];var count=0;var restartCheck=setInterval(function(){count++;if(maxRetries==0||count<=maxRetries){$.when.apply($,urls.map(function(url){return $.ajax({url:url,beforeSend:function(jqXHR,settings){if($.ajaxSettings.headers){delete $.ajaxSettings.headers["x-csrftoken"]}}})})).done(function(){onSuccess()}).fail(function(){onError()})}else{clearInterval(restartCheck)}},10000)}
function batchGroupState(show){var groups=tabulatorTable.getGroups();var numGroups=groups.length;var originalPageSize=tabulatorTable.getPageSize();tabulatorTable.setPageSize(10);for(i=0;i<numGroups;i++){if(show){groups[i].show()}
else{groups[i].hide()}}
tabulatorTable.setPageSize(originalPageSize)}
function batchSelect(select){var languageFound=!1;var rows=tabulatorTable.getRows();updates=[]
rows.forEach(function(row){var data=row.getData()
if(data.select!==null){data.select=select;updates.push(data);languageFound=!0}});tabulatorTable.updateData(updates);if(select==!0&&languageFound){changeState(StateEnum.ALL_SELECTED)}else{changeState(StateEnum.NONE_SELECTED)}}
var getCookieValue=function(cookie_name){var cookieValue=document.cookie.replace(/(?:(?:^|.*;\s*)test2\s*\=\s*([^;]*).*$)|^.*$/,"$1")}
var loadLoginData=function(){var username=$.cookie('os_username');var password=$.cookie('os_password');if(username&&password){$("#os-username").val(username);$("#os-password").val(password);guiLoginSuccess()}
else{guiLoginClear()}}
var clearCookies=function(){$.removeCookie('os_username',{path:'/'});$.removeCookie('os_password',{path:'/'})}
var guiLoginClear=function(){loggedIn=!1;$("#test-login-spinner").prop('hidden',!0);$("#test-login-error-msg").prop('hidden',!0);$("#test-login-success").prop('hidden',!0);$("#os-password").prop('disabled',!1);$("#os-username").prop('disabled',!1);$("#os-username").css('background-color','');$("#os-password").css('background-color','');$("#test-login-btn").prop('hidden',!1);$("#edit-login-btn").prop('hidden',!0)}
var guiLoginSuccess=function(){loggedIn=!0;$("#test-login-spinner").prop('hidden',!0);$("#test-login-success").prop('hidden',!1);$("#os-username").prop('disabled',!0);$("#os-password").prop('disabled',!0);$("#test-login-btn").prop('hidden',!0);$("#edit-login-btn").prop('hidden',!1)}
var guiLoginError=function(errorText){guiLoginClear();$("#test-login-error-msg").text(errorText);$("#test-login-error-msg").prop('hidden',!1);$("#os-username").css('background-color','#ffcaca');$("#os-password").css('background-color','#ffcaca');$("#seek_status").prop('hidden',!0)}
$(document).ready(function(){var logoCollapse=function(){if($(document).scrollTop()>100){$("#logo").addClass("logo-shrink");$("#logo").removeClass("logo-grow")}else{$("#logo").addClass("logo-grow");$("#logo").removeClass("logo-shrink")}};logoCollapse();$(window).scroll(logoCollapse);tippy('#tooltip',{content:"Select the movie files from disk. Don't worry, you will <b><i>not</i></b> be uploading any files to our servers. We only use the selection to calculate which subtitles to retrieve. This all happens client-side and blazingly fast, you'll see.",placement:"left-start",size:"large",arrow:!0,arrowType:"sharp",delay:[0,0]})
tippy('#info-tooltip',{content:"OpenSubtitles sets a download limit per user (200 subs/24h or 1000 subs/24h for VIPs). Therefore you need to login with your OpenSubtitles account. The credentials are not stored or logged by us! If you don't have credentials, click the link to register.",placement:"top",size:"large",arrow:!0,arrowType:"sharp",delay:[0,0]})
$('.tabulator-col').addClass("tabulator-sortable");$('.tabulator-col-content').append("<div class='tabulator-arrow'></div>");$("#search-config-form").submit(function(event){event.preventDefault();if($('#language-select')[0].selectedOptions.length==0){$("#lang_error").prop('hidden',!1);$('.ms-selection').addClass('invalid_input')}else if(loggedIn==!1){guiLoginError("Please login first.")}else{$("#seek_status").prop('hidden',!1);$("#lang_error").prop('hidden',!0);$('.ms-selection').removeClass('invalid_input');fetchAndDisplaySubtitles(function(){$("#seek_status").prop('hidden',!0);changeState(StateEnum.FINAL)})}});$("#start-over-btn").click(function(){location.reload(!0);tabulatorTable.redraw()});$("#test-login-btn").click(function(){guiLoginClear();username=$("#os-username").val();password=$("#os-password").val();if(username==""||password==""){guiLoginError("Empty username or password.");return}
$("#test-login-spinner").prop('hidden',!1);login(username,password,guiLoginSuccess,guiLoginError)});$("#edit-login-btn").click(function(){guiLoginClear();$("#os-username").select();$("#os-password").val('');clearCookies()});$('.panel-collapse').on('show.bs.collapse',function(){$(this).siblings('.panel-heading').addClass('active')});$('.panel-collapse').on('hide.bs.collapse',function(){$(this).siblings('.panel-heading').removeClass('active')});$('#language-select').multiSelect({afterSelect:function(values){$("#lang_error").prop('hidden',!0);$('.ms-selection').removeClass('invalid_input');if($('#language-select')[0].selectedOptions.length>maxLanguages){$('#language-select').multiSelect('deselect',values)
window.alert("Sorry, we only support a maximum of 5 languages right now in this beta phase.\n\nLet us know if you require more and we'll see what we can do.")}},afterDeselect:function(values){}});$('#select-all').click(function(){$('#language-select').multiSelect('select_all')});$('#deselect-all').click(function(){$('#language-select').multiSelect('deselect_all')});$('#expand-all').click(function(){batchGroupState(!0)});$('#collapse-all').click(function(){batchGroupState(!1)});var column_title=$('#select-header').parent()
var column_content=column_title.parent();column_title.css('padding-right',0);column_title.css('text-align',"center");column_content.find('.tabulator-arrow').remove();$("#select-header").on("click",function(){if($(this).attr("select-all")==="checked"){batchSelect(!1);$(this).removeClass("fas fa-check-square").addClass("far fa-square");$(this).attr("select-all","unchecked")}else{batchSelect(!0);$(this).removeClass("far fa-square").addClass("fas fa-check-square");$(this).attr("select-all","checked")}});$('#download-selection').click(function(){var zip_choice=$('#zip_contents').val();zipSelection(zip_choice)});getHealthStatus(200,0,function(){$('#os-health').removeClass('led-red');$('#os-health').addClass('led-green');$(".callout").animate({right:'-400px'})},function(){$('#os-health').removeClass('led-green');$('#os-health').addClass('led-red');$(".callout").animate({right:'-1px'})})
clearCookies()})