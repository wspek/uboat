var state,sortWithFixedGroup=function(e,t){e.preventDefault();var a="asc";tabulatorTable.getSorters();tabulatorTable.getSorters().forEach(function(e){t.getField()==e.column.getField()&&(a=e.dir)}),tabulatorTable.setSort([{column:t,dir:"asc"==a?"desc":"asc"},{column:"header",dir:"asc"}])},tickToggle=function(e,t){var a=t.getValue();null!==a&&(t.setValue(!a),changeState(StateEnum.SELECTION_CHANGED))},loggedIn=!0,StateEnum={INITIAL:1,FILES_ADDED:2,FINAL:3,SELECTION_CHANGED:4,NONE_SELECTED:5,ALL_SELECTED:6},maxFiles=100,maxLanguages=5,movieFiles=[],fileSelectClass=document.getElementsByClassName("select"),tabulatorTable=new Tabulator("#subtitle-table",{placeholder:"No titles added yet",pagination:"local",paginationSize:25,paginationSizeSelector:[10,25,50,100],layout:"fitColumns",layoutColumnsOnNewData:!0,columns:[{title:"#",field:"id",width:1,widthShrink:1,sorter:"string",visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Enabled",field:"enabled",visible:!1},{title:"Header",field:"header",visible:!1},{title:"link_gz",field:"link_gz",visible:!1},{title:"link_zip",field:"link_zip",visible:!1},{title:"language_id",field:"language_id",visible:!1},{title:"Added titles",field:"placeholder",formatter:"html",visible:!0,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Movie size (bytes)",field:"file_size",width:160,widthShrink:1,visible:!0,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Movie hash",field:"hash",width:160,widthShrink:1,visible:!0,headerSort:!1,headerClick:sortWithFixedGroup},{title:"<i id='select-header' class='select-cell fas fa-check-square' select-all='checked'></i>",width:40,widthShrink:1,headerSort:!1,field:"select",visible:!1,cellClick:tickToggle,formatter:"tickCross",formatterParams:{allowEmpty:!0,tickElement:"<i class='select-cell fas fa-check-square'></i>",crossElement:"<i class='select-cell far fa-square'></i>"}},{title:"Subtitle file",field:"sub_filename",minWidth:150,sorter:"string",visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"S",field:"season",width:44,widthShrink:1,sorter:"string",headerTooltip:"Season",widthShrink:1,visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"E",field:"episode",width:44,widthShrink:1,sorter:"string",headerTooltip:"Episode",widthShrink:1,visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Language",field:"language_name",width:140,minWidth:70,widthShrink:1,sorter:"string",visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Format",field:"format",width:83,widthShrink:1,sorter:"string",visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Encoding",field:"encoding",width:100,widthShrink:1,sorter:"string",visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Date added",field:"add_date",width:150,widthShrink:1,visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Score",field:"score",width:76,widthShrink:1,sorter:"number",visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Rating",field:"rating",width:80,widthShrink:1,sorter:"number",visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Uploader rank",field:"rank",sorter:"string",width:140,widthShrink:1,visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"#DL",field:"num_downloads",sorter:"number",width:65,widthShrink:1,headerTooltip:"Number of downloads by others",visible:!1,headerSort:!1,headerClick:sortWithFixedGroup},{title:"Download",field:"download",formatter:"html",width:110,minWidth:110,visible:!1,headerSort:!1,headerClick:sortWithFixedGroup}],resizableColumns:!0,rowFormatter:function(e){0==e.getData().enabled&&(e.getElement().style.backgroundColor="#ffffe5",e.getElement().style.fontStyle="italic")},groupBy:"header",groupToggleElement:"header",groupStartOpen:function(e,t,a,i){return 1==a[0].id},groupClick:function(e,t){scrollPosX=window.scrollX,scrollPosY=window.scrollY},groupVisibilityChanged:function(e,t){window.scrollTo(scrollPosX,scrollPosY)},pageLoaded:function(e){window.scrollTo(scrollPosX,scrollPosY)}},scrollPosX=0,scrollPosY=0);function redrawTable(){tabulatorTable.redraw()}function addTableData(e,t){e.id;tabulatorTable.updateOrAddData([e]).then(function(e){}).catch(function(e){})}var addMovieFilesToTable=function(){var e=[].slice.call(this.files).sort(function(e,t){return e.name<=t.name?-1:1});function t(e){return function(t,a){!function(e){movieFiles.push(e),addTableData(e),changeState(StateEnum.FILES_ADDED)}({id:e,header:t.name,movie_filename:t.name,placeholder:"<i>Fetch subtitles to display them in this table</i>",file_size:t.size.toString().replace(/\B(?=(?:\d{3})+(?!\d))/g,","),hash:a})}}nextId=tabulatorTable.getDataCount()+1,function(a){var l=a;if(l+e.length>maxFiles+1)window.alert("Sorry, you can only add a maximum of 100 titles.\nOtherwise the U-Boat may sink and not surface no more...");else for(i=0;i<e.length;i++){for(var o=e[i],n=!1,s=0;s<movieFiles.length;s++)if(movieFiles[s].movie_filename==o.name){n=!0;break}n||(calcFileHash(o,t(l)),l++)}}(nextId)};function fetchAndDisplaySubtitles(e){var t={movie_files:movieFiles};langSelectElement=$("#language-select"),langSelectElement.children("option:selected").length==langSelectElement[0].length?t.languages=["all"]:t.languages=$("#language-select").val(),$('input[type="radio"]:checked').each(function(){t.search_method=$(this).val()}),getAvailableLanguages(function(e){this.availableLanguages=e});searchSubtitles(t,function(t){$("#collapseOne").collapse();for(var a=tabulatorTable.getRows(),i=tabulatorTable.getDataCount(),l=1;l<i+1;l++)tabulatorTable.getRow(l).delete();var o=1;for(l=0;l<a.length;l++){var n=a[l].getData().movie_filename,s=t[n];for(j in s)result=s[j],result.id=o,result.header=n,result.sub_filename?(result.select=!0,result.download="<a href='"+result.link_zip+"' target='_blank'>ZIP</a>&nbsp;&nbsp;<a href='"+result.link_gz+"' target='_blank'>GZ</a>&nbsp;&nbsp;<button class='btn-unzip' zip='"+result.link_zip+"' onclick='unzipAndLink(this)'>"+result.format.toUpperCase()+"</button>"):(result.select=null,result.sub_filename="Language not found for this title",result.language_name=this.availableLanguages[result.language_id][0],result.enabled=!1),addTableData(result),o++}var r=tabulatorTable.getColumns();for(l=6;l<r.length;l++)r[l].toggle();var d=tabulatorTable.getGroups();for(l in d)d[l].show();tabulatorTable.setSort([{column:"header",dir:"asc"},{column:"language_name",dir:"asc"}]),redrawTable(),e()},function(e){401==e.status?(changeState(StateEnum.INITIAL),$("#edit-login-btn").click(),guiLoginError(e.responseText)):403==e.status&&($("#seek_status").prop("hidden",!0),$("#page_error").prop("hidden",!1),changeState(StateEnum.FINAL))})}function unzipAndLink(e){var t=e.getAttribute("zip"),a=document.createElement("i");a.classList.add("fas"),a.classList.add("fa-circle-notch"),a.classList.add("fa-spin"),e.innerHTML="",e.classList.add("buttonload"),e.appendChild(a),model.getEntries(t,function(t){t.forEach(function(t){if(e.parentNode){var a=e.parentNode.parentNode.querySelector('[tabulator-field="id"]').innerText,i=tabulatorTable.getRow(a),l=i.getData(),o=l.format;if(t.filename.slice(-3).toUpperCase()==o.toUpperCase()){var n=l.download,s=(new DOMParser).parseFromString(n,"text/html");s.getElementsByTagName("button")[0].remove();var r=o+"_"+a,d=s.body.innerHTML+'<a href="#" id="'+r+'">'+o.toUpperCase()+"</a>";tabulatorTable.updateData([{id:a,download:d}]),t.filename="["+l.language_id.toUpperCase()+"] "+t.filename;var c=document.getElementById(r);download(t,c).then(function(){d=s.body.innerHTML+c.outerHTML,tabulatorTable.updateData([{id:a,download:d}])}),event.preventDefault(),i.reformat()}}})},function(t,i,l){e.classList.remove("buttonload"),a.classList.remove("fas"),a.classList.remove("fa-circle-notch"),a.classList.remove("fa-spin"),a.classList.add("fa"),a.classList.add("fa-exclamation-circle"),$("#manual-download").attr("href",l),$("#download_error").prop("hidden",!1)})}function zipOfCompressedFiles(e,t){var a={},l=[],o=tabulatorTable.getRows();for(i in o)if(data=o[i].getData(),data.select){var n="["+data.language_id.toUpperCase()+"] "+data.sub_filename,s=data["link_"+e];a.hasOwnProperty(n)?(a[n]++,n=n+" ("+a[n]+")"):a[n]=0,l.push({file_name:n+"."+e,link:s})}downloadFiles(l).then(t)}function downloadFiles(e){return new Promise(function(t,a){blobs=[],e.forEach(function(a){downloadSubtitleAsBlob(a.link,function(i){i.name=a.file_name,blobs.push(i),e.length==blobs.length&&t(blobs)})})})}function zipOfSubtitles(e,t){var a={},l=[],o=tabulatorTable.getRows();for(i in o)if(data=o[i].getData(),data.select){var n="["+data.language_id.toUpperCase()+"] "+data.sub_filename,s=data.link_zip;if(a.hasOwnProperty(n)){a[n]++;var r=n.lastIndexOf("."),d=n.slice(0,r),c=n.slice(r);n=d+" ("+a[n]+")"+c}else a[n]=0;l.push({file_name:n,format:data.format,link:s})}var u=[];for(i in l){var h=l[i].link;function p(a){model.getEntries(h,function(t){t.forEach(function(t){if(t.filename.slice(-3).toUpperCase()==l[a].format.toUpperCase()){downloadBlob(t).then(function(t){return function(i){i.name=l[a].file_name,t.push(i),t.length===l.length&&e(t)}}(u))}})},function(e,a,i){t()})}p(i)}}function zipSelection(e){var t=document.getElementById("download-selection"),a=document.createElement("i");a.classList.add("fas"),a.classList.add("fa-circle-notch"),a.classList.add("fa-spin"),t.innerHTML="",t.classList.add("buttonload"),t.appendChild(a);var i=function(e){zipModel.setCreationMethod("Blob"),zipModel.addFiles(e,function(){},function(){},function(){},function(){zipModel.getBlobURL(function(e){var i=document.createElement("a");i.appendChild(document.createTextNode("Download selection")),i.style.visibility="hidden",i.setAttribute("href",e),i.setAttribute("download","uboat_subtitles.zip"),document.body.appendChild(i),i.click(),i.remove(),t.removeChild(a),t.classList.remove("buttonload"),t.innerHTML="Download selection"})})};"sub"===e?zipOfSubtitles(i,function(e){t.classList.remove("buttonload"),t.classList.remove("btn-primary"),t.classList.add("btn-warning"),a.classList.remove("fas"),a.classList.remove("fa-circle-notch"),a.classList.remove("fa-spin"),a.classList.add("fa"),a.classList.add("fa-exclamation-circle"),a.classList.add("black"),$("#manual-download").removeAttr("href"),$("#download_error").prop("hidden",!1)}):zipOfCompressedFiles(e,i)}function changeState(e){switch(e){case StateEnum.INITIAL:tabulatorTable.redraw();break;case StateEnum.FILES_ADDED:$("#fetch-btn").removeClass("disabled"),$("#fetch-btn").attr("aria-disabled",!1);break;case StateEnum.FINAL:$("#choose-titles-btn").prop("hidden",!0),$("#start-over-btn").prop("hidden",!1),$("#fetch-btn").addClass("disabled"),$("#fetch-btn").attr("aria-disabled",!0);case StateEnum.SELECTION_CHANGED:var t=!1,a=!0;tabulatorTable.getRows().forEach(function(e){var i=e.getData();null!==i.select&&(t=!0,!0===i.select&&(a=!1))}),t&&!a?($("#download-selection").removeClass("disabled"),$("#download-selection").attr("aria-disabled",!1),$("#zip_contents").prop("disabled",!1)):($("#download-selection").addClass("disabled"),$("#download-selection").attr("aria-disabled",!0),$("#zip_contents").prop("disabled",!0),"checked"===$("#select-header").attr("select-all")&&$("#select-header").trigger("click"));break;case StateEnum.NONE_SELECTED:$("#download-selection").addClass("disabled"),$("#download-selection").attr("aria-disabled",!0),$("#zip_contents").prop("disabled",!0);break;case StateEnum.ALL_SELECTED:$("#download-selection").removeClass("disabled"),$("#download-selection").attr("aria-disabled",!1),$("#zip_contents").prop("disabled",!1);break;default:console.log("ERROR: Reached default in switch statement")}e=e}for(var i=0;i<fileSelectClass.length;i++)fileSelectClass[i].addEventListener("change",addMovieFilesToTable);function getHealthStatus(e,t,a,i){var l=["server_health","https://api.opensubtitles.org/xml-rpc"],o=0,n=setInterval(function(){o++,0==t||o<=t?$.when.apply($,l.map(function(e){return $.ajax({url:e,beforeSend:function(e,t){$.ajaxSettings.headers&&delete $.ajaxSettings.headers["x-csrftoken"]}})})).done(function(){a()}).fail(function(){i()}):clearInterval(n)},1e4)}function batchGroupState(e){var t=tabulatorTable.getGroups(),a=t.length,l=tabulatorTable.getPageSize();for(tabulatorTable.setPageSize(10),i=0;i<a;i++)e?t[i].show():t[i].hide();tabulatorTable.setPageSize(l)}function batchSelect(e){var t=!1,a=tabulatorTable.getRows();updates=[],a.forEach(function(a){var i=a.getData();null!==i.select&&(i.select=e,updates.push(i),t=!0)}),tabulatorTable.updateData(updates),changeState(1==e&&t?StateEnum.ALL_SELECTED:StateEnum.NONE_SELECTED)}var getCookieValue=function(e){document.cookie.replace(/(?:(?:^|.*;\s*)test2\s*\=\s*([^;]*).*$)|^.*$/,"$1")},loadLoginData=function(){var e=$.cookie("os_username"),t=$.cookie("os_password");e&&t?($("#os-username").val(e),$("#os-password").val(t),guiLoginSuccess()):guiLoginClear()},clearCookies=function(){$.removeCookie("os_username",{path:"/"}),$.removeCookie("os_password",{path:"/"})},guiLoginClear=function(){loggedIn=!1,$("#test-login-spinner").prop("hidden",!0),$("#test-login-error-msg").prop("hidden",!0),$("#test-login-success").prop("hidden",!0),$("#os-password").prop("disabled",!1),$("#os-username").prop("disabled",!1),$("#os-username").css("background-color",""),$("#os-password").css("background-color",""),$("#test-login-btn").prop("hidden",!1),$("#edit-login-btn").prop("hidden",!0)},guiLoginSuccess=function(){loggedIn=!0,$("#test-login-spinner").prop("hidden",!0),$("#test-login-success").prop("hidden",!1),$("#os-username").prop("disabled",!0),$("#os-password").prop("disabled",!0),$("#test-login-btn").prop("hidden",!0),$("#edit-login-btn").prop("hidden",!1)},guiLoginError=function(e){guiLoginClear(),$("#test-login-error-msg").text(e),$("#test-login-error-msg").prop("hidden",!1),$("#os-username").css("background-color","#ffcaca"),$("#os-password").css("background-color","#ffcaca"),$("#seek_status").prop("hidden",!0)};$(document).ready(function(){var e=function(){$(document).scrollTop()>100?($("#logo").addClass("logo-shrink"),$("#logo").removeClass("logo-grow")):($("#logo").addClass("logo-grow"),$("#logo").removeClass("logo-shrink"))};e(),$(window).scroll(e),tippy("#tooltip",{content:"Select the movie files from disk. Don't worry, you will <b><i>not</i></b> be uploading any files to our servers. We only use the selection to calculate which subtitles to retrieve. This all happens client-side and blazingly fast, you'll see.",placement:"left-start",size:"large",arrow:!0,arrowType:"sharp",delay:[0,0]}),tippy("#info-tooltip",{content:"OpenSubtitles sets a download limit per user (200 subs/24h or 1000 subs/24h for VIPs). Therefore you need to login with your OpenSubtitles account. The credentials are not stored or logged by us! If you don't have credentials, click the link to register.",placement:"top",size:"large",arrow:!0,arrowType:"sharp",delay:[0,0]}),$(".tabulator-col").addClass("tabulator-sortable"),$(".tabulator-col-content").append("<div class='tabulator-arrow'></div>"),$("#search-config-form").submit(function(e){e.preventDefault(),0==$("#language-select").children("option:selected").length?($("#lang_error").prop("hidden",!1),$(".ms-selection").addClass("invalid_input")):0==loggedIn?guiLoginError("Please login first."):($("#seek_status").prop("hidden",!1),$("#lang_error").prop("hidden",!0),$(".ms-selection").removeClass("invalid_input"),fetchAndDisplaySubtitles(function(){$("#seek_status").prop("hidden",!0),changeState(StateEnum.FINAL)}))}),$("#start-over-btn").click(function(){location.reload(!0),tabulatorTable.redraw()}),$("#test-login-btn").click(function(){guiLoginClear(),username=$("#os-username").val(),password=$("#os-password").val(),""!=username&&""!=password?($("#test-login-spinner").prop("hidden",!1),login(username,password,guiLoginSuccess,guiLoginError)):guiLoginError("Empty username or password.")}),$("#edit-login-btn").click(function(){guiLoginClear(),$("#os-username").select(),$("#os-password").val(""),clearCookies()}),$(".panel-collapse").on("show.bs.collapse",function(){$(this).siblings(".panel-heading").addClass("active")}),$(".panel-collapse").on("hide.bs.collapse",function(){$(this).siblings(".panel-heading").removeClass("active")}),$("#language-select").multiSelect({afterSelect:function(e){$("#lang_error").prop("hidden",!0),$(".ms-selection").removeClass("invalid_input"),$("#language-select").children("option:selected").length>maxLanguages&&($("#language-select").multiSelect("deselect",e),window.alert("Sorry, we only support a maximum of 5 languages right now in this beta phase.\n\nLet us know if you require more and we'll see what we can do."))},afterDeselect:function(e){}}),$("#select-all").click(function(){$("#language-select").multiSelect("select_all")}),$("#deselect-all").click(function(){$("#language-select").multiSelect("deselect_all")}),$("#expand-all").click(function(){batchGroupState(!0)}),$("#collapse-all").click(function(){batchGroupState(!1)});var t=$("#select-header").parent(),a=t.parent();t.css("padding-right",0),t.css("text-align","center"),a.find(".tabulator-arrow").remove(),$("#select-header").on("click",function(){"checked"===$(this).attr("select-all")?(batchSelect(!1),$(this).removeClass("fas fa-check-square").addClass("far fa-square"),$(this).attr("select-all","unchecked")):(batchSelect(!0),$(this).removeClass("far fa-square").addClass("fas fa-check-square"),$(this).attr("select-all","checked"))}),$("#download-selection").click(function(){zipSelection($("#zip_contents").val())}),getHealthStatus(200,0,function(){$("#os-health").removeClass("led-red"),$("#os-health").addClass("led-green"),$(".callout").animate({right:"-400px"})},function(){$("#os-health").removeClass("led-green"),$("#os-health").addClass("led-red"),$(".callout").animate({right:"-1px"})}),clearCookies()});